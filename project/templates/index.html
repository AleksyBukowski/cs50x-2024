{% extends "layout.html" %}

{% block title %} Posts {% endblock %}

{% block post %}
<div class="w-50">
    <a id="post_btn" class="btn" style="margin-left: 69%" href="/create">Post your idea now</a>
</div>
{% endblock %}

{% block main %}
<h2 id="shareyourideas" class="text-center">Share Your Ideas!</h2>

<div id="post-container" class="post-container row">
    <!-- posts generated by db -->
</div>

<!-- Pagination Buttons -->
<div class="pagination-container d-flex justify-content-between mb-4 pb-3">
    <button id="prevPage" class="btn btn-secondary" style="width:40%; margin-left: 5%">&#8592;</button>
    <button id="nextPage" class="btn btn-primary" style="width:40%; margin-right: 5%">&#8594;</button>
</div>

<script>
let currentPage = 1; // Track the current page
const postsPerPage = {{posts_per_page}}; // Number of posts per page

// Function to load posts dynamically from the backend
async function loadPosts(page) {
    const postContainer = document.getElementById('post-container');
    postContainer.innerHTML = ''; // Clear previous posts

    try {
        // Fetch posts from the backend API
        const response = await fetch(`/get_posts?page=${page}&limit=${postsPerPage}`);
        const data = await response.json();

        const posts = data.posts; // Retrieved posts
        const totalPosts = data.total; // Total number of posts from the backend
        const MAX_PREVIEW_LENGTH = 200; // Define max preview length

        // Render each post dynamically
        posts.forEach(post => {
            const truncatedText = post.text.length > MAX_PREVIEW_LENGTH
                ? post.text.slice(0, MAX_PREVIEW_LENGTH) + '...'
                : post.text;
            const postDiv = document.createElement('div');
            postDiv.classList.add("col-md-4", "mb-4"); // Make posts responsive and add margin
            postDiv.innerHTML = `
                <a href="/post/${post.id}" class="post">
                    <h5>${post.title}</h5>
                    <p class="p-post">${truncatedText}</p>
                </a>
            `;
            postContainer.appendChild(postDiv);
        });

        // Toggle the state of pagination buttons
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');

        // Update "Previous Page" button state
        prevPageBtn.disabled = (page === 1); // Disable "Previous" if on the first page

        // Update "Next Page" button state
        nextPageBtn.disabled = (page * postsPerPage >= totalPosts); // Disable "Next" if no more posts
    } catch (error) {
        console.error("Failed to load posts:", error);
    }
}

// Event listeners for pagination buttons
document.getElementById('nextPage').addEventListener('click', () => {
    currentPage++;
    loadPosts(currentPage);
});

document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) {
        currentPage--;
        loadPosts(currentPage);
    }
});

// Load the first page of posts on initial load
loadPosts(currentPage);

</script>

{% endblock %}
